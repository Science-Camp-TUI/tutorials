
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://science-camp-tui.github.io/tutorials/system/index.html">
      
      
        <link rel="prev" href="../machine-learning/code-snippets.html">
      
      
        <link rel="next" href="code-snippets.html">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.25">
    
    
      
        <title>System Components - Science Camp 2024 - Workshop Tutorials</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.6543a935.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#iot-system-tutorials" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../index.html" title="Science Camp 2024 - Workshop Tutorials" class="md-header__button md-logo" aria-label="Science Camp 2024 - Workshop Tutorials" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Science Camp 2024 - Workshop Tutorials
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              System Components
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



  

<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../index.html" title="Science Camp 2024 - Workshop Tutorials" class="md-nav__button md-logo" aria-label="Science Camp 2024 - Workshop Tutorials" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Science Camp 2024 - Workshop Tutorials
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../index.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../starter/index.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Starter Tutorial
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Machine Learning Tutorials
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Machine Learning Tutorials
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../machine-learning/index.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Introduction
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../machine-learning/audio-processing.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Audio Processing
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../machine-learning/bird-classification.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Bird Classification
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../machine-learning/code-snippets.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Code-Snippets
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    IoT System Tutorial
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            IoT System Tutorial
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    System Components
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="index.html" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    System Components
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#lessons-steps" class="md-nav__link">
    <span class="md-ellipsis">
      Lessons Steps
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Lessons Steps">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#part-1-the-file-reader" class="md-nav__link">
    <span class="md-ellipsis">
      Part 1: The File Reader
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#part-2-the-classifier" class="md-nav__link">
    <span class="md-ellipsis">
      Part 2: The Classifier
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#part-3-the-transmitter-serial-sender" class="md-nav__link">
    <span class="md-ellipsis">
      Part 3: The Transmitter (Serial Sender)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#party-3b-transmitting-directly-to-the-mqtt-broker" class="md-nav__link">
    <span class="md-ellipsis">
      Party 3b: Transmitting directly to the MQTT broker
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#part-4-bringing-it-all-together" class="md-nav__link">
    <span class="md-ellipsis">
      Part 4: Bringing it all together
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#part-5-the-transmitter-pcb-optional" class="md-nav__link">
    <span class="md-ellipsis">
      Part 5: The Transmitter PCB (optional)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#part-6-testing" class="md-nav__link">
    <span class="md-ellipsis">
      Part 6: Testing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#part-7-transfer-to-the-raspberry-pi" class="md-nav__link">
    <span class="md-ellipsis">
      Part 7: Transfer to the Raspberry Pi
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#part-8-database-interface-optional" class="md-nav__link">
    <span class="md-ellipsis">
      Part 8: Database interface (optional)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="code-snippets.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Code-Snippets
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Dashboard Tutorials
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Dashboard Tutorials
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../dashboard/index.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Dashboard Tutorial
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../dashboard/join.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Joins
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="iot-system-tutorials">IoT System Tutorials</h1>
<p>Now that you know how to process audio and classify them, you will learn how to </p>
<ul>
<li>
<p>continuously process incoming audio data</p>
</li>
<li>
<p>classify the data and accumulate the results</p>
</li>
<li>
<p>transmit the classification data via a long range transmission network. </p>
</li>
</ul>
<p>In the scenario, we are simulating, the process of classifying bird songs is continuous. Imagine using a microphone with enough energy resources, the system could be put into the woods for days for recording and continuously transmitting its results.</p>
<p>In this tutorial we simulate the microphone with a file reader.</p>
<p>The following sequence diagram shows the systems data flow and the components that are involved. </p>
<p><img alt="System Architecture" src="pictures/system_components.svg" /></p>
<p>The following components have already been set up by us and are only shown here for the sake of completeness, of the components shown you will only work with Grafana during the dashboard tutorial.</p>
<p><img alt="System Architecture" src="pictures/communication_components.svg" /></p>
<h2 id="lessons-steps">Lessons Steps</h2>
<p>As you can see from the diagram, the main components run in parallel and transmit their data via so called queues. In order to make them run in parallel we use Python Threads <sup id="fnref:1"><a class="footnote-ref" href="#fn:1">1</a></sup>. </p>
<p>We will use a class for each component. The class will contain all the necessary methods and attributes to run the component. The common structure will be as follows. </p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Thread</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="k">class</span> <span class="nc">ComponentClass</span><span class="p">(</span><span class="n">Thread</span><span class="p">):</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="o">...</span><span class="p">):</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="k">def</span> <span class="nf">interrupt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</span></code></pre></div>
<p>The main things to considers during this lessons are:</p>
<ul>
<li>
<p>which information / data / object does each component need (we shall add them in the <code>__init__</code> method)</p>
</li>
<li>
<p>what do we need to do in the run method (which, for the most components will loop endlessly)</p>
</li>
<li>
<p>how can we interrupt the main loops of each component.  <strong>This is important because it gives the user the possibility to stop the program before finishing.</strong></p>
</li>
</ul>
<p>Before starting, download the files </p>
<ul>
<li>
<p><a href="files/SMM11597_20240330_151602.wav" target="_blank">SMM11597_20240330_151602.wav</a> </p>
</li>
<li>
<p><a href="files/SMM11597_Summary.txt" target="_blank">SMM11597_Summary.txt</a> </p>
</li>
</ul>
<p>and copy them into a new folder <code>real_data</code> in your project folder. We will use the folder in all steps of this tutorial.</p>
<h3 id="part-1-the-file-reader">Part 1: The File Reader</h3>
<ol>
<li>
<p>Create a file <code>file_reader.py</code> in the <code>birdnet_mini</code> folder. In this file, implement the <code>FileReader</code> class using the template from above.</p>
</li>
<li>
<p>The <code>FileReader</code> class constructor shall receive </p>
<ul>
<li>a file path to one ore more audio files, </li>
<li>a path to a meta data file created by the microphone containing the time stamps of the audio files and the latitude/longitude coordinates of the microphone during recording, </li>
<li>the queue to send the sample chunks and metadata to </li>
<li>and the sample rate it shall create the chunks with (we will fix the duration (3s), overlap (0s) and min length (1) in this tutorial). </li>
</ul>
<p>Store these values in member variables (e.g. <code>self._sample_rate</code>).</p>
</li>
<li>
<p>Still in the <code>__init__</code>  method, parse the folder for all audio files (wav, or mp3 etc.) and store the file paths in a list as a member variable.</p>
</li>
<li>
<p>Download the file <a href="files/metadata.py" target="_blank">metadata.py</a>  in the <code>birdnet_mini</code> folder and use the <code>MetaData</code> class from this file to store it in the member variable <code>self._metadata</code>. <strong>(Optional)</strong> Instead of downloading the implementation of the <code>MetaData</code> class, you can also implement it yourself. For format reference check the file  <a href="files/SMM11597_Summary.txt" target="_blank">SMM11597_Summary.txt</a>  from the <code>real_data</code>.</p>
</li>
<li>
<p>Implement the <code>run</code> method. In this method, you iterate over the audio file names one by one in a loop and extract the metadata per file and create the chunks of audio data. </p>
<p>a. Before opening the audio file, extract the basename of the file  (e.g. <code>SMM11597_20240330_151602</code>)<sup id="fnref:2"><a class="footnote-ref" href="#fn:2">2</a></sup> and use it to get the <code>timestamp</code>, <code>latitude (lat)</code> and <code>longitude</code> using the <code>MetaData.get_timestamp_lat_lon</code> method.</p>
<p>b. Use the methods <code>open_audio_file</code> and <code>split_signal</code> from your <code>audio.py</code> file to get the chunks from the audio file. </p>
</li>
<li>
<p>For each chunk put a tuple to the sample queue that contains <code>(chunk, timestamp, latitude, longitude)</code> in a second nested loop. In each iteration of the outer loop, check if the component has been interrupted. If so, break the loop.</p>
</li>
</ol>
<h3 id="part-2-the-classifier">Part 2: The Classifier</h3>
<ol>
<li>
<p>Create a file <code>classifier.py</code> in the <code>birdnet_mini</code> folder. In this file, implement the <code>BirdClassifier</code> class using the template from above.</p>
</li>
<li>
<p>The <code>BirdClassifier</code> class constructor shall receive </p>
<ul>
<li>an instance of the Model class you implemented in the previous lesson, </li>
<li>the queue to receive the sample chunks and metadata from</li>
<li>and the queue to send the classification results to (result queue).</li>
</ul>
<p>Store these values in member variables (e.g. <code>self._model</code>).</p>
</li>
<li>
<p>Implement the <code>run</code> method. In this method, create an loop that runs until <code>self._interrupted</code> is <code>True</code>. In this loop</p>
<ul>
<li>retrieve the next tuple of  <code>(chunk, timestamp, latitude, longitude)</code>. Use the <code>Queue.get</code> method with a short timeout of <code>0.1</code> to retrieve the tuple <sup id="fnref3:3"><a class="footnote-ref" href="#fn:3">3</a></sup>.</li>
<li>classify the chunk using the <code>Model.predict</code> method.</li>
<li>Store the result in a dictionary:
    <div class="language-python highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>    <span class="s2">&quot;class_id&quot;</span><span class="p">:</span> <span class="n">class_id</span><span class="p">,</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>    <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">confidence</span><span class="p">,</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>    <span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="n">random_lat</span><span class="p">,</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>    <span class="s2">&quot;lon&quot;</span><span class="p">:</span> <span class="n">random_lon</span><span class="p">,</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>    <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="p">}</span>
</span></code></pre></div></li>
<li>Put the data into the result queue.</li>
</ul>
</li>
</ol>
<h3 id="part-3-the-transmitter-serial-sender">Part 3: The Transmitter (Serial Sender)</h3>
<ol>
<li>
<p>Create a file <code>transmission.py</code> in the <code>birdnet_mini</code> folder. In this file, implement the <code>SerialSender</code> class using the template from above.</p>
</li>
<li>
<p>The <code>SerialSender</code> class constructor shall receive </p>
<ul>
<li>the queue to read the classification results from (result queue)</li>
<li>the serial port to be used  (e.g. <code>/dev/ttyUSB0</code> or <code>COM1</code>) to send the data to</li>
<li>the serial baud rate to be used. Set it to <code>115200</code> as default.</li>
<li>an interval in seconds to when data shall be sent. This is important, since the the receiving Raspberry Pico can only handle a certain amount of data per second. Set it to <code>2</code> as default.</li>
</ul>
</li>
<li>
<p>Implement the <code>run</code> method. In this method, create a loop that runs until <code>self._interrupted</code> is <code>True</code>. In this loop</p>
<ul>
<li>retrieve the next classification result. Use the <code>Queue.get</code> method with a short timeout of <code>0.1</code> to retrieve the tuple <sup id="fnref2:3"><a class="footnote-ref" href="#fn:3">3</a></sup>.</li>
<li>Since we cannot send the whole dictionary (e.g. as Json) we need to pack the data as efficiently as possible. Store the values of the dictionary in a list with the following order:
    <div class="language-python highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="n">data_simple</span> <span class="o">=</span> <span class="p">[</span><span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;class_id&#39;</span><span class="p">],</span> <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;confidence&#39;</span><span class="p">],</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>                   <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">],</span> <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">],</span> <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()]</span>
</span></code></pre></div></li>
<li>
<p>Now use the <a href="https://docs.python.org/3/library/struct.html" target="_blank">Python Struct Package</a> to pack the data into a binary data. Use the format string <code>'Hfffd'</code> for the packing. </p>
</li>
<li>
<p>Send the packed data over the serial port. We use the <a href="https://pyserial.readthedocs.io/en/latest/shortintro.html" target="_blank">Python Serial Package</a> to send the data.</p>
</li>
<li>
<p>wait for the time interval before sending the next data.</p>
</li>
<li>
<p>when the loop is interrupted, close the serial port.</p>
</li>
</ul>
</li>
</ol>
<h3 id="party-3b-transmitting-directly-to-the-mqtt-broker">Party 3b: Transmitting directly to the MQTT broker</h3>
<p>Due to some limitations of the Mioty system, it is helpful for you to send the data directly to the MQTT broker instead of sending it via the serial port and the antenna. For this reason, we will also create an MQTT sender class. </p>
<ol>
<li>
<p>Create a file <code>transmissionMQTT.py</code> in the <code>birdnet_mini</code> folder. In this file, implement the <code>MQTTSender</code> class using the template from above.</p>
</li>
<li>
<p>The <code>MQTTSender</code> class constructor shall receive </p>
<ul>
<li>the queue to read the classification results from (result queue)</li>
<li>an interval in seconds to when data shall be sent. We keep this parameter in order to change the overall system as little as possible, and unlike the port and baud rate, this parameter also has an effect on the behaviour of the broker.</li>
</ul>
</li>
<li>
<p>In the <code>__init__</code> create a MQTT client. We use the <a href="https://pypi.org/project/paho-mqtt/">paho-mqtt packet</a>, the required informations about the broker are in the moodle course.</p>
<ul>
<li>Since we use plain text credentials, it is recommended to bind them to variables in a separately created config.py, and to import only the config in this file.</li>
<li>Use the client as a <code>self</code> variable. You will have to set username and password for the client as well as address and port of the broker</li>
</ul>
</li>
<li>
<p>Implement the <code>run</code> method. In this method, create a loop that runs until <code>self._interrupted</code> is <code>True</code>. In this loop</p>
<ul>
<li>retrieve the next classification result. Use the <code>Queue.get</code> method with a short timeout of <code>0.1</code> to retrieve the tuple <sup id="fnref:3"><a class="footnote-ref" href="#fn:3">3</a></sup>.</li>
<li>Since we cannot send the whole dictionary (e.g. as Json) we need to pack the data as efficiently as possible. Store the values of the dictionary in a list with the following order:
    <div class="language-python highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="n">data_simple</span> <span class="o">=</span> <span class="p">[</span><span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;class_id&#39;</span><span class="p">],</span> <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;confidence&#39;</span><span class="p">],</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>                   <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">],</span> <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">],</span> <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()]</span>
</span></code></pre></div></li>
<li>
<p>Now use the <a href="https://docs.python.org/3/library/struct.html" target="_blank">Python Struct Package</a> to pack the data into a binary data. Use the format string <code>'Hfffd'</code> for the packing. </p>
</li>
<li>
<p>Send the packed data over to the MQTT broker. Use <code>topicGroup&lt;your group number&gt;</code> as the topic. You can use the client function publish to do that.</p>
</li>
<li>
<p>wait for the time interval before sending the next data.</p>
</li>
<li>
<p>when the loop is interrupted, close the serial port.</p>
</li>
</ul>
</li>
</ol>
<h3 id="part-4-bringing-it-all-together">Part 4: Bringing it all together</h3>
<p>Now you have all the components ready. You can now modify your main file <code>main.py</code> in the <code>birdnet_mini</code> folder. </p>
<ol>
<li>
<p>Import the classes <code>FileReader</code>, <code>BirdClassifier</code> and <code>SerialSender</code> from the respective files.</p>
</li>
<li>
<p>Create instances of the classes and start them as threads.</p>
</li>
<li>
<p>Create an endless loop waiting a short amount of time in each loop, that is surrounded by a code part catching user interrupts (e.g. pressing <code>Ctrl+C</code>):</p>
<p><div class="language-python highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="k">try</span><span class="p">:</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>    <span class="o">...</span>
</span></code></pre></div>
4. when interrupted, stop the threads by calling the <code>interrupt</code> method of each component and join the threads using the <code>Thread.join</code> method.</p>
</li>
</ol>
<h3 id="part-5-the-transmitter-pcb-optional">Part 5: The Transmitter PCB (optional)</h3>
<p>We use a Rapsberry Pico microcontroller connected via USB serial port. The Hardware is a custom layout created by the TU Ilmenau. I holds the Pico as well as the sending module. </p>
<p><img alt="Raspberry Pico" src="pictures/pico.jpg" width="40%" /></p>
<p>The code for the microcontroller is written in C++ and pretty simple. However, adding it to this tutorial would be too much. The whole repository can be found <a href="https://github.com/Science-Camp-TUI/TS-UNB-Lib-Pico">here</a> on the <code>science-camp</code> branch.</p>
<h3 id="part-6-testing">Part 6: Testing</h3>
<p>Connect the Raspberry Pico to your computer and start the python program. You should see the data being sent to the Pico. You can also monitor the mqtt broker, using <a href="https://github.com/Science-Camp-TUI/mqtt-mini/blob/main/mqtt_client.py">this python program</a>. If you are transmitting without the antenna you can use the same credentials for the mqtt broker, otherwise talk to an instuctor.</p>
<h3 id="part-7-transfer-to-the-raspberry-pi">Part 7: Transfer to the Raspberry Pi</h3>
<p>Once tested successfully, the code needs to be transferred to the Raspberry Pi. You may zip it and copy it over. The instructor will guide you through the process of running the code on the Raspberry Pi.</p>
<h3 id="part-8-database-interface-optional">Part 8: Database interface (optional)</h3>
<p>If you are very fast and want to work on a separate task from this tutorial, you can try to implement the interface between mqtt and the InfluxDB yourself. But be sure to speak to a instructor first.</p>
<p>What the program needs to accomplish is decoding the recieved data, labeling the seperate fields and send it to the database.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p><a href="https://docs.python.org/3/library/threading.html" target="_blank">Python Threads</a> are used to run multiple tasks concurrently. Threads are lighter than processes and share the same memory space. They are perfect for IO-bound tasks, such as reading from a file or sending data over a network. Please notice that python threads are not real system threads such as in programming languages like C++.&#160;<a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p>You may use the <a href="https://docs.python.org/3/library/pathlib.html" target="_blank">Python pathlib module stem function</a> to extract the basename of the file.&#160;<a class="footnote-backref" href="#fnref:2" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
<li id="fn:3">
<p>Make sure you handle the <code>queue.Empty</code> exception that is raised when the queue is empty and the timeout is over.&#160;<a class="footnote-backref" href="#fnref:3" title="Jump back to footnote 3 in the text">&#8617;</a><a class="footnote-backref" href="#fnref2:3" title="Jump back to footnote 3 in the text">&#8617;</a><a class="footnote-backref" href="#fnref3:3" title="Jump back to footnote 3 in the text">&#8617;</a></p>
</li>
</ol>
</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.path", "toc.integrate"], "search": "../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.081f42fc.min.js"></script>
      
    
  </body>
</html>